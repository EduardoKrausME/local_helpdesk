<div class="ticket-details row">

    <div class="col-md-7 col-lg-8 col-xxl-9">
        <div class="card">
            <div class="card-header">
                <h5>{{{subject}}}</h5>
            </div>
            <div class="card-body">
                <div class="ml-5">
                    {{{description}}}
                </div>
                {{#ticketfiles_count}}
                    <div class="d-flex flex-wrap row">
                        {{#ticketfiles}}
                            <div class="mb-3 col-6 col-sm-4">
                                <a class="ticket-attachments p-3 w-100"
                                   target="_blank"
                                   href="{{fullurl}}">
                                    <h6 class="mb-0">{{{filename}}}</h6>
                                    <p class="mb-0 text-secondary">{{{mimetype}}}</p>
                                </a>
                            </div>
                        {{/ticketfiles}}
                    </div>
                {{/ticketfiles_count}}
            </div>
        </div>

        {{#responses}}
            {{#has_message}}
                <div class="shadow-sm border-0 card">
                    <div class="card-header response-header">
                        <img alt="{{user_fullname}}" class="img-fluid" src="{{user_picture}}">
                        <h6 class="mb-0">{{user_fullname}}</h6>
                        <div style="margin-left: auto;"><em style="font-size: .8em">{{createdat}}</em></div>
                    </div>
                    <div class="card-body">
                        <div class="ml-5">
                            {{{message}}}
                        </div>
                        {{#responsefiles_count}}
                            <div class="d-flex flex-wrap row">
                                {{#responsefiles}}
                                    <div class="mb-3 col-6 col-sm-4">
                                        <a class="ticket-attachments p-3 w-100"
                                           target="_blank"
                                           href="{{fullurl}}">
                                            <h6 class="mb-0">{{{filename}}}</h6>
                                            <p class="mb-0 text-secondary">{{{mimetype}}}</p>
                                        </a>
                                    </div>
                                {{/responsefiles}}
                            </div>
                        {{/responsefiles_count}}
                    </div>
                </div>
            {{/has_message}}

            {{#has_status}}
                <div class="shadow-sm border-0 card ml-5 mb-2">
                    <div class="card-body response-header p-1 pl-3 pr-3">
                        <img alt="{{user_fullname}}" class="img-fluid" src="{{user_picture}}">
                        <h6 class="mb-0">{{user_fullname}}</h6>
                        <div>{{{message}}}</div>
                        <div style="margin-left:auto;"><em style="font-size: .8em">{{createdat}}</em></div>
                    </div>
                </div>
            {{/has_status}}

            {{#has_info}}
                has_info
            {{/has_info}}
        {{/responses}}

    </div>

    <div class="col-md-5 col-lg-4 col-xxl-3">
        <div class="card">
            <div class="card-header">
                <div class="ticket-profile">
                    <div class="ticket-profile-user">
                        <img alt="Avatar" class="img-fluid " src="{{{user_picture}}}">
                    </div>
                    <div class="ml-3">
                        <h6 class="mb-0">{{{user_fullname}}}</h6>
                        {{#user.phone1}}
                            <div class="text-secondary">{{{user.phone1}}}</div>
                        {{/user.phone1}}
                        {{^user.phone1}}
                            {{#user.phone2}}
                                <div class="text-secondary">{{{user.phone2}}}</div>
                            {{/user.phone2}}
                        {{/user.phone1}}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="about-list pt-0">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-medium">{{#str}}ticketid, local_khelpdesk{{/str}}:</span>
                        <span class="text-secondary">#{{{idkey}}}</span>
                    </div>
                    {{#course_fullname}}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-medium">{{#str}}course{{/str}}:</span>
                            <span class="text-secondary">{{course_fullname}}</span>
                        </div>
                    {{/course_fullname}}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-medium">{{#str}}ticketstatus, local_khelpdesk{{/str}}:</span>
                        {{#hasmanage}}
                            <select name="changue_status" id="changue_status"
                                    data-column="status">
                                {{#status_options}}
                                    <option value="{{key}}" {{selected}}>{{lang}}</option>
                                {{/status_options}}
                            </select>
                        {{/hasmanage}}
                        {{^hasmanage}}
                            <span class="badge status-{{status}}">{{status_translated}}</span>
                        {{/hasmanage}}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-medium">{{#str}}ticketpriority, local_khelpdesk{{/str}}:</span>

                        {{#hasmanage}}
                            <select name="changue_priority" id="changue_priority"
                                    data-column="priority">
                                {{#priority_options}}
                                    <option value="{{key}}" {{selected}}>{{lang}}</option>
                                {{/priority_options}}
                            </select>
                        {{/hasmanage}}
                        {{^hasmanage}}
                            <span class="badge priority-{{priority}}">{{priority_translated}}</span>
                        {{/hasmanage}}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-medium">{{#str}}ticketcategory, local_khelpdesk{{/str}}:</span>
                        {{#hasmanage}}
                            <select name="changue_category" id="changue_category"
                                    data-column="category">
                                {{#category_options}}
                                    <option value="{{key}}" {{selected}}>{{lang}}</option>
                                {{/category_options}}
                            </select>
                        {{/hasmanage}}
                        {{^hasmanage}}
                            <span class="text-secondary">{{category_translate}}</span>
                        {{/hasmanage}}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-medium">{{#str}}ticketcreatedat, local_khelpdesk{{/str}}:</span>
                        <span class="text-secondary">{{createdat}}</span>
                    </div>
                    <div class="alert alert-success"
                         style="display:none"
                         id="local_khelpdesk_ticket_column"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h5>{{#str}}attachment, local_khelpdesk{{/str}}</h5>
            </div>
            {{#allfiles_count}}
                <div class="card-body">
                    {{#allfiles}}
                        <a class="ticket-attachments p-2 mb-2 w-100"
                           target="_blank"
                           href="{{fullurl}}">
                            <p class="mb-0">{{{filename}}}</p>
                            <p class="mb-0 text-secondary">{{{mimetype}}}</p>
                        </a>
                    {{/allfiles}}
                </div>
            {{/allfiles_count}}
        </div>
    </div>
</div>

{{#js}}
    /*
    <script>*/
    require(["jquery", "core/ajax", "core/notification"], function($, Ajax, Notification) {
        $("#changue_status,#changue_priority,#changue_category").on("change", function() {
            var value = $(this).val();

            Ajax.call([{
                methodname: "local_khelpdesk_ticket_column",
                args: {
                    idkey: "{{{idkey}}}",
                    column: $(this).attr("data-column"),
                    value: value,
                }
            }])[0].then(function(data) {
                console.log(data.status);
                $("#local_khelpdesk_ticket_column").show(200).html(data.status);
                setTimeout(function() {
                    $("#local_khelpdesk_ticket_column").show(200);
                }, 2000);

            }).catch(Notification.exception);
        });
    });
{{/js}}